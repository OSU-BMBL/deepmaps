print(p1)
dev.off()
}
### UP
if (length(this_up) > 10) {
enriched_combined <- enrichr(this_up, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5, -6)])
})
for (idx in seq_along(enriched_combined)) {
this_res <- enriched_combined[[idx]]
this_name <- names(enriched_combined[idx])
this_selected_terms <- this_res[1:10, ]
enrichment_dotplot(
this_selected_terms,
filename = paste0(
RESULT_DIR,
"enrich_plot_top10_up_",
this_name,
".png"
)
)
}
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_up.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_up.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_up.csv")
)
write.csv(
enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, this_cluster, "_KEGG_up.csv")
)
}
### DOWN
if (length(this_down) > 10) {
enriched_combined <- enrichr(this_down, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5, -6)])
})
for (idx in seq_along(enriched_combined)) {
this_res <- enriched_combined[[idx]]
this_name <- names(enriched_combined[idx])
this_selected_terms <- this_res[1:10, ]
enrichment_dotplot(
this_selected_terms,
filename = paste0(
RESULT_DIR,
"enrich_plot_top10_down_",
this_name,
".png"
)
)
}
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_down.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_down.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_down.csv")
)
write.csv(enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_down.csv"))
}
}
}
dir.create(paste0("../result/deg"))
dir.create(paste0("../result/deg/cfs_vs_pbmc"))
Idents(combined) <- combined$orig.ident
this_clusters <- levels(as.factor(combined$seurat_clusters))
i = 9
ident1 <- "cfs"
ident2 <- "pbmc"
DefaultAssay(combined) <- "RNA"
for (i in seq_along(this_clusters)) {
this_cluster <- this_clusters[i]
Idents(combined) <- combined$seurat_clusters
this_combined <-
subset(combined, ident = this_cluster)
Idents(this_combined) <- this_combined$orig.ident
DefaultAssay(this_combined) <- "RNA"
# cells in each idents > 5 and number of idents > 1
if (all(as.numeric(table(this_combined$orig.ident)) > 5 & length(table(this_combined$orig.ident)) > 1)) {
dir.create(paste0(
"../result/deg/",
ident1,
"_vs_",
ident2,
"/cluster_",
this_cluster
))
RESULT_DIR <-
paste0(paste0(
"../result/deg/",
ident1,
"_vs_",
ident2,
"/cluster_",
this_cluster,
"/"
))
cts_markers <-
FindMarkers(this_combined,
ident.1 = ident1,
ident.2 = ident2) %>%
rownames_to_column("gene") %>%
filter(p_val_adj < 0.05) %>%
write_csv(paste0(RESULT_DIR, "deg.csv"))
this_up <- cts_markers %>%
filter(avg_log2FC > 0) %>%
pull(gene)
this_down <- cts_markers %>%
filter(avg_log2FC < 0) %>%
pull(gene)
# Volcano
if (length(this_up) > 10 &
length(this_down) > 10) {
top_up <- cts_markers %>%
top_n(5, avg_log2FC) %>%
pull(gene)
top_down <- cts_markers %>%
top_n(-5, avg_log2FC) %>%
pull(gene)
p1 <- EnhancedVolcano(
cts_markers,
lab = cts_markers$gene,
x = 'avg_log2FC',
y = 'p_val_adj',
selectLab = c(top_up, top_down),
pCutoff = 0.05,
FCcutoff = 0.25,
drawConnectors = TRUE
)
png(
paste0(RESULT_DIR, "volcano.png"),
width = 3000,
height = 3000,
res = 300
)
print(p1)
dev.off()
}
### UP
if (length(this_up) > 10) {
enriched_combined <- enrichr(this_up, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5, -6)])
})
for (idx in seq_along(enriched_combined)) {
this_res <- enriched_combined[[idx]]
this_name <- names(enriched_combined[idx])
this_selected_terms <- this_res[1:10, ]
enrichment_dotplot(
this_selected_terms,
filename = paste0(
RESULT_DIR,
"enrich_plot_top10_up_",
this_name,
".png"
)
)
}
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_up.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_up.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_up.csv")
)
write.csv(
enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_up.csv")
)
}
### DOWN
if (length(this_down) > 10) {
enriched_combined <- enrichr(this_down, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5, -6)])
})
for (idx in seq_along(enriched_combined)) {
this_res <- enriched_combined[[idx]]
this_name <- names(enriched_combined[idx])
this_selected_terms <- this_res[1:10, ]
enrichment_dotplot(
this_selected_terms,
filename = paste0(
RESULT_DIR,
"enrich_plot_top10_down_",
this_name,
".png"
)
)
}
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_down.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_down.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_down.csv")
)
write.csv(enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_down.csv"))
}
}
}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
library(Seurat)
library(cowplot)
library(dplyr)
library(ggplot2)
library(patchwork)
library(here)
library(qs)
library(Polychrome)
library(EnhancedVolcano)
library(tidyverse)
library(enrichR)
library(scRepertoire)
this_sample <- "cfs"
dir.create(paste0("../result/deg"))
dir.create(paste0("../result/deg/cluster_specific_genes"))
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample))
Idents(combined) <- combined$orig.ident
DefaultAssay(combined) <- "RNA"
this_combined <-
subset(combined, ident = this_sample)
Idents(this_combined) <- this_combined$seurat_clusters
this_combined
# 30 mins
cts_markers <- FindAllMarkers(this_combined)
i = 1
for (i in seq_along(levels(cts_markers$cluster))) {
this_cluster <- levels(cts_markers$cluster)[i]
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster))
cts_markers %>%
filter(cluster == this_cluster) %>%
write_csv(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster,"/cluster_specific_genes.csv"))
}
#cts_markers <- read.csv("cluster_specific_genes_combined.csv")
i=1
DefaultAssay(this_combined) <- "RNA"
Idents(this_combined) <- this_combined$seurat_clusters
for (i in seq_along(levels(Idents(this_combined)))) {
Idents(this_combined) <- this_combined$seurat_clusters
this_cluster <- levels(Idents(this_combined))[i]
RESULT_DIR <- paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster,"/")
res <- cts_markers %>%
dplyr::filter(cluster == this_cluster & p_val_adj < 0.05) %>%
dplyr::select(gene, avg_log2FC)
this_up <- res %>%
filter(avg_log2FC > 0) %>%
pull(gene)
this_down <- res %>%
filter(avg_log2FC < 0) %>%
pull(gene)
### UP
if (length(this_up) > 10) {
enriched_combined <- enrichr(this_up, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5,-6)])
})
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_up.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_up.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_up.csv")
)
write.csv(
enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_up.csv")
)
}
### DOWN
if (length(this_down) > 10) {
enriched_combined <- enrichr(this_down, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5,-6)])
})
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_down.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_down.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_down.csv")
)
write.csv(enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_down.csv"))
}
}
this_sample <- "pbmc"
dir.create(paste0("../result/deg"))
dir.create(paste0("../result/deg/cluster_specific_genes"))
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample))
Idents(combined) <- combined$orig.ident
DefaultAssay(combined) <- "RNA"
this_combined <-
subset(combined, ident = this_sample)
Idents(this_combined) <- this_combined$seurat_clusters
# 30 mins
cts_markers <- FindAllMarkers(this_combined)
cts_markers %>%
write_csv(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_specific_genes_combined.csv"))
i = 1
for (i in seq_along(levels(cts_markers$cluster))) {
this_cluster <- levels(cts_markers$cluster)[i]
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster))
cts_markers %>%
filter(cluster == this_cluster) %>%
write_csv(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster,"/cluster_specific_genes.csv"))
}
#cts_markers <- read.csv("cluster_specific_genes_combined.csv")
i=1
DefaultAssay(this_combined) <- "RNA"
Idents(this_combined) <- this_combined$seurat_clusters
for (i in seq_along(levels(Idents(this_combined)))) {
Idents(this_combined) <- this_combined$seurat_clusters
this_cluster <- levels(Idents(this_combined))[i]
RESULT_DIR <- paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster,"/")
res <- cts_markers %>%
dplyr::filter(cluster == this_cluster & p_val_adj < 0.05) %>%
dplyr::select(gene, avg_log2FC)
this_up <- res %>%
filter(avg_log2FC > 0) %>%
pull(gene)
this_down <- res %>%
filter(avg_log2FC < 0) %>%
pull(gene)
### UP
if (length(this_up) > 10) {
enriched_combined <- enrichr(this_up, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5,-6)])
})
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_up.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_up.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_up.csv")
)
write.csv(
enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_up.csv")
)
}
### DOWN
if (length(this_down) > 10) {
enriched_combined <- enrichr(this_down, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5,-6)])
})
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_down.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_down.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_down.csv")
)
write.csv(enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_down.csv"))
}
}
this_sample <- "cfs_and_pbmc"
dir.create(paste0("../result/deg"))
dir.create(paste0("../result/deg/cluster_specific_genes"))
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample))
Idents(combined) <- combined$orig.ident
DefaultAssay(combined) <- "RNA"
this_combined <-
subset(combined, ident = c("cfs","pbmc"))
Idents(this_combined) <- this_combined$seurat_clusters
this_combined
combined
this_sample <- "cfs_and_pbmc"
dir.create(paste0("../result/deg"))
dir.create(paste0("../result/deg/cluster_specific_genes"))
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample))
Idents(combined) <- combined$orig.ident
DefaultAssay(combined) <- "RNA"
this_combined <-
subset(combined, ident = c("cfs","pbmc"))
Idents(this_combined) <- this_combined$seurat_clusters
# 30 mins
cts_markers <- FindAllMarkers(this_combined)
cts_markers %>%
write_csv(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_specific_genes_combined.csv"))
i = 1
for (i in seq_along(levels(cts_markers$cluster))) {
this_cluster <- levels(cts_markers$cluster)[i]
dir.create(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster))
cts_markers %>%
filter(cluster == this_cluster) %>%
write_csv(paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster,"/cluster_specific_genes.csv"))
}
#cts_markers <- read.csv("cluster_specific_genes_combined.csv")
i=1
DefaultAssay(this_combined) <- "RNA"
Idents(this_combined) <- this_combined$seurat_clusters
for (i in seq_along(levels(Idents(this_combined)))) {
Idents(this_combined) <- this_combined$seurat_clusters
this_cluster <- levels(Idents(this_combined))[i]
RESULT_DIR <- paste0("../result/deg/cluster_specific_genes/",this_sample, "/cluster_",this_cluster,"/")
res <- cts_markers %>%
dplyr::filter(cluster == this_cluster & p_val_adj < 0.05) %>%
dplyr::select(gene, avg_log2FC)
this_up <- res %>%
filter(avg_log2FC > 0) %>%
pull(gene)
this_down <- res %>%
filter(avg_log2FC < 0) %>%
pull(gene)
### UP
if (length(this_up) > 10) {
enriched_combined <- enrichr(this_up, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5,-6)])
})
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_up.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_up.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_up.csv")
)
write.csv(
enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_up.csv")
)
}
### DOWN
if (length(this_down) > 10) {
enriched_combined <- enrichr(this_down, dbs)
enriched_combined <- lapply(enriched_combined, function(x) {
x$Overlap <- paste0(" ", x$Overlap)
return(x[, c(-5,-6)])
})
write.csv(
enriched_combined$GO_Molecular_Function_2018,
paste0(RESULT_DIR, "GO_MF_down.csv")
)
write.csv(
enriched_combined$GO_Cellular_Component_2018,
paste0(RESULT_DIR, "GO_CC_down.csv")
)
write.csv(
enriched_combined$GO_Biological_Process_2018,
paste0(RESULT_DIR, "GO_BP_down.csv")
)
write.csv(enriched_combined$KEGG_2019_Human,
paste0(RESULT_DIR, "KEGG_down.csv"))
}
}
